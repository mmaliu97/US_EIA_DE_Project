x-superset-user: &superset-user root
x-superset-volumes: &superset-volumes
  # /app/pythonpath_docker will be appended to the PYTHONPATH in the final container
  - ./docker:/app/docker
  # - ./superset:/app/superset
  # - ./docker/superset_config.py:/app/pythonpath/superset_config.py

services:
  # db:
  #   container_name: postgres_container_eia
  #   image: postgres:14.20
  #   ports:
  #     - 5432:5432
  #   environment:
  #     POSTGRES_DB: ${POSTGRES_DB}
  #     POSTGRES_USER: ${POSTGRES_USER}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #     EIA_API_KEY: ${EIA_API_KEY}

  #   volumes:
  #     - ./postgres/data:/var/lib/postgresql/data
  #     - ./postgres/airflow_init.sql:/docker-entrypoint-initdb.d/airflow_init.sql
  #   networks:
  #     - my-network

  af:
    container_name: airflow_container_eia
    image: apache/airflow:3.1.3
    ports:
      - 8000:8080
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${DBT_USER}:${DBT_PASS}@${DBT_HOST}:5432/neondb?sslmode=require
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      DBT_HOST: ${DBT_HOST}
      DBT_USER: ${DBT_USER}
      DBT_PASS: ${DBT_PASS}
      DBT_DATABASE: ${DBT_DATABASE}
      EIA_API_KEY: ${EIA_API_KEY}
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./api_request:/opt/airflow/api_request    
      - /var/run/docker.sock:/var/run/docker.sock
    group_add:
      - '1001'
    networks:
      - my-network
    command: >
      bash -c "airflow db migrate && airflow standalone"

  # dbt:
  #   container_name: dbt_container_eia
  #   image: ghcr.io/dbt-labs/dbt-postgres:1.9.latest
  #   volumes:
  #     - ./dbt/my_project:/usr/app
  #     - ./dbt:/root/.dbt
  #   working_dir: /usr/app
  #   environment:
  #     DBT_HOST: ${DBT_HOST}
  #     DBT_USER: neondb_owner
  #     DBT_PASS: ${DBT_PASS}
  #     DBT_PORT: 5432
  #     DBT_DATABASE: ${DBT_DATABASE}
  #     DBT_PROFILES_DIR: "/root/.dbt"
  #     EIA_API_KEY: ${EIA_API_KEY}
  #     # Required for Neon SSL
  #     PGSSLMODE: require

  #   networks:
  #     - my-network
  #   command: run

networks:
  my-network:
    driver: bridge

volumes:
    postgres_data:
